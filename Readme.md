# LBM Saclay

This is a [Lattice Boltzmann](https://en.wikipedia.org/wiki/Lattice_Boltzmann_methods) miniapp written in C++ and using [Kokkos library](https://github.com/kokkos/kokkos) for shared memory parallelization.

# Get the source

## from git

Our miniApp uses kokkos as a git submodule, configured to use the `develop` branch of kokkos.
In order to download the sources all-in-one (LBM miniApp + kokkos):

```shell
git clone --recursive https://codev-tuleap.cea.fr/plugins/git/lbmsaclay/LBM_Saclay_Rech-Dev.git
```

Alternatively, if you didn't use option `--recursive` (to populate git submodules), you can do it afterwards:
```shell
git submodule update --init --recursive
```

Please note that if you forget to populate git submodule, the top-level CMakeLists.txt will enforce it anyway.

## from a source tarball

You don't need to do anything, `LBM_Saclay` and external dependencies are already included.

# LBM_Saclay's documentation

The official LBM_Saclay's documentation is available online on:

```shell
google-chrome https://cea-lbm-saclay.github.io/LBM_Saclay_Documentation/index.html
```

All instructions for compilation, mathematical models and run test cases on several supercomputers are detailed. Below are given instructions to start quickly.

# Build LBM Saclay

We strongly recommend the out-of-source build, so that one can have one build directory per architecture.

## build for Kokkos/OpenMP

To build for Kokkos/OpenMP backend (which is the default backend):

```shell
mkdir build_openmp; cd build_openmp
cmake -DKokkos_ENABLE_OPENMP=ON ..
make
```

You should now have executable *LBM_saclay*. You can run a simple transport test like this

```shell
cd src
./LBM_saclay ../../settings/transport/test_lbm_d2q9_transport.ini
```

Optionally but recommended, you can activate HWLOC support by turning ON the flag Kokkos_ENABLE_HWLOC.

## build for Kokkos/OpenMP + MPI

To build for Kokkos/OpenMP backend and MPI (for distributed parallism) :

```shell
mkdir build_openmp_mpi; cd build_openmp_mpi
cmake -DKokkos_ENABLE_OPENMP=ON -DUSE_MPI=ON ..
make
```

How to run :

here is an example using 4 MPI tasks, each running 2 OpenMP threads

```shell
cd src
mpirun -x OMP_NUM_THREADS=2 -np 4 ./LBM_saclay ../../settings/transport/test_lbm_d2q5_transport_mpi.ini
```

Be careful that the number of MPI process passed to `mpirun` must match the product `mx*my*mz`, where `mx`, `my`, `mz` are the sizes of the MPI cartesian topology.

## build for Kokkos/CUDA

Obviously, you need to have Nvidia/CUDA driver and toolkit installed on your platform.
Then you need to
 1. tell cmake to use kokkos compiler wrapper for cuda:

    ```shell
    mkdir build_cuda; cd build_cuda
    # nvcc_wrapper is located inside kokkos sources, most probably
    # $(LBM_SACLAY_TOPDIR)/external/kokkos/bin/nvcc_wrapper
    export CXX=/complete/path/to/kokos/bin/nvcc_wrapper
    ```
 2. activate CUDA backend in the ccmake interface.
    * Just turn on Kokkos_ENABLE_CUDA
    * select cuda architecture, e.g. set Kokkos_ARCH to Kepler37 (for Nvidia K80 boards); obviously you need to change Kokkos ARCH to the GPU hardware available on your host machine

    ```shell
    cmake -DKokkos_ENABLE_OPENMP=ON -DKokkos_ENABLE_CUDA=ON -DKokkos_ENABLE_CUDA_LAMBDA=ON -DKokkos_ARCH_KEPLER37=ON ..
    ```


then `make` should give you a working executable `LBM_saclay` running on GPU.

```shell
cd src
./LBM_saclay ../../settings/transport/test_lbm_d2q9_transport.ini
```

## build for Kokkos/CUDA + MPI

Same as above except that, your environment variables must be set this way:

```shell
export OMPI_CXX=/path/to/nvcc_wrapper
export CXX=mpicxx
```

Example configuration on machine 132.167.204.83

```shell
module load cuda/3.1.2_cuda8.0
export OMPI_CXX=/path/to/nvcc_wrapper
export CXX=/opt/local/openmpi-3.1.2_cuda8.0/bin/mpicxx
mkdir build_cuda_mpi; cd build_cuda_mpi
cmake -DKokkos_ENABLE_OPENMP=ON -DKokkos_ENABLE_CUDA=ON -DKokkos_ENABLE_CUDA_LAMBDA=ON -DKokkos_ARCH_KEPLER37=ON -DUSE_MPI=ON -DUSE_MPI_CUDA_AWARE_ENFORCED=ON ..
make -j 8
```

Example run using a 2x2 domain decomposition

```shell
mpirun -np 4 ./LBM_saclay ../../settings/test_lbm_d2q9_double_poiseuille.ini --kokkos-ndevices=4
```

## Build Documentation

### Regular doxygen documentation is available.

To build it, just add `-DLBM_SACLAY_BUILD_DOC=ON` to cmake command line argument

``` shell
mkdir build
cd build
cmake $(OTHER_CMAKE_ARGS) -DLBM_SACLAY_BUILD_DOC:BOOL=ON -DLBM_SACLAY_DOC:STRING=doxygen ..
make doc
firefox build/doc/doxygen/html/index.html
```

### Full documentation with doxygen generated by mkdocs

``` shell
mkdir build
cd build
cmake $(OTHER_CMAKE_ARGS) -DLBM_SACLAY_BUILD_DOC:BOOL=ON -DLBM_SACLAY_DOC:STRING=mkdocs ..
make doc
cd build/doc/mkdocs
mkdocs serve
firefox http://127.0.0.1:8000/
```

### Documentation requirements

- [doxygen](https://www.doxygen.nl/index.html)
- [mkdocs](https://www.mkdocs.org/)
  ```shell
  conda install -c conda-forge mkdocs
  ```
- (optional) [doxybook2](https://github.com/matusnovak/doxybook2); we recommend that you install is from a binary release at [https://github.com/matusnovak/doxybook2/tags](https://github.com/matusnovak/doxybook2/tags).


## Build for eclipse

Outside of source directory:

```shell
cmake -G "Eclipse CDT4 - Unix Makefiles" -DKokkos_ENABLE_OPENMP:BOOL=ON ../LBM_saclay
```

this will generate a `.project` file which will enable you to open the project with eclipse.
